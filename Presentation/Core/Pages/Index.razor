@page "/"
@using Domain.Refrescos.Entities
@using Domain.Efectivo.Entities
@using Application.Refrescos
@using Application.Efectivo
@using Presentation.Core.Components
@inject IDineroService DineroService
@inject IRefrescoService RefrescoService
@inject ISnackbar Snackbar

<MudTable @ref="@_mudTable" Items="@_refrescos" Hover="true" Breakpoint="Breakpoint.Sm">
	 <ToolBarContent>
        <MudText>Refrescos disponibles</MudText>
        <MudSpacer />
    </ToolBarContent> 
    <HeaderContent>
        <MudTh>Cantidad Disponible</MudTh>
        <MudTh>Nombre del refresco</MudTh>
        <MudTh>Precio por unidad</MudTh>
        <MudTh>Unidades seleccionadas</MudTh>
    </HeaderContent>
        
    <RowTemplate>
        <MudTd DataLabel="Cantidad Disponible">@context.CantidadDisponible</MudTd>
        <MudTd DataLabel="Nombre del refresco">@context.Nombre</MudTd>
        <MudTd DataLabel="Precio por unidad">₡ @context.Precio</MudTd>
        <MudTd DataLabel="Unidades seleccionadas">
            <MudNumericField @bind-Value="context.CantidadSolicitada" Variant="Variant.Text" Min="0" Max="@context.CantidadDisponible"/>
        </MudTd>
    </RowTemplate>
</MudTable>
<br>
<MudGrid>
    <MudItem xs="4">
        <MudButton Variant="Variant.Filled" OnClick=OpenDialog Color="Color.Secondary">
            <MudText>Pagar</MudText>
        </MudButton>
    </MudItem>
    <MudItem xs="4"></MudItem>
    <MudItem xs="3">
        <MudText Inline="true">Monto total: ₡ @ObtenerMontoTotal()</MudText>
    </MudItem>
</MudGrid>

<MudDialog @bind-IsVisible="_visible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Filled.AttachMoney" Color="@Color.Primary" Class="mr-2"/>Ingrese la cantidad de dinero con la que va a pagar</MudText>
    </TitleContent>
    <DialogContent>
        <MudTable @ref="@_mudTableDialog" Items="@_dineroCliente" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Monto</MudTh>
                <MudTh>Cantidad</MudTh>
            </HeaderContent>
        
            <RowTemplate>
                <MudTd DataLabel="Monto">@context.Denominacion</MudTd>
                <MudTd DataLabel="Cantidad">
                    <MudNumericField @bind-Value="context.Cantidad" Variant="Variant.Text" Min="0"/>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </DialogContent>
    <DialogActions>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Class="px-10">Aceptar</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Transparent" OnClick="CloseDialog" Class="px-10">Cancelar</MudButton>
    </DialogActions>
</MudDialog>

@code{
    private MudTable<Refresco> _mudTable;
    private MudTable<Dinero> _mudTableDialog;
    private IList<Refresco> _refrescos;
    private IList<Dinero> _dineroCliente;
    private IList<Dinero> _cambioMaquina;
    private bool _cargando = true;
    private bool _visible;

    void CloseDialog() => _visible = false;
    private DialogOptions dialogOptions = new() { FullWidth = true };
    private void OpenDialog()
    {
        if (ObtenerMontoTotal() > 0)
        {
            _visible = true;
        }
        else
        {
            Snackbar.Add("Por favor seleccione los refrescos que desea comprar", Severity.Warning);
        }
    } 


    protected override async Task OnInitializedAsync()
    {
        _refrescos = RefrescoService.CrearInventario();
        _cambioMaquina = DineroService.CrearFondo();
        _cargando = false;
    }

    private double ObtenerMontoTotal()
    {
        double monto = 0;
        foreach (Refresco refresco in _refrescos.Where(e => e.CantidadSolicitada > 0))
        {
            monto += refresco.Precio * Convert.ToDouble(refresco.CantidadSolicitada);
        }
        return monto;
    }

    private void ActualizarDisponibles()
    {
        _refrescos = RefrescoService.ActualizarInventario(_refrescos);
    }
}
